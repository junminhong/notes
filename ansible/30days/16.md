# Day16 - 今日來點比較進階的 Inventory
## 今日目標
- 熟悉 INI 與 YAML 兩種 Inventory 格式
- 學會合併多個 Inventory 來源與套用群組/子群組
- 掌握主機匹配語法、群組/主機變數位置與優先序重點
- 認識動態 Inventory（Inventory Plugins）、Constructed 分群

## 靜態 Inventory：INI 與 YAML
- 你已經有的範例：
```ini
# inventory.ini（已存在）
[all]
192.0.2.10 ansible_user=ubuntu
192.0.2.11 ansible_user=ubuntu
192.0.2.12 ansible_user=ubuntu
```
```yaml
---
# host.yaml（已存在
web_servers:
  hosts:
    vultr:
      ansible_host: 45.76.99.205
      ansible_port: 22
      ansible_user: deploy
      ansible_python_interpreter: /usr/bin/python3
```

驗證與檢視：
```bash
ansible-inventory -i snippets/inventory.ini --graph
ansible-inventory -i snippets/host.yaml --list | head -n 40
```

## 合併多個 Inventory 來源

- 直接以逗號串接：
```bash
ansible-inventory -i 'snippets/inventory.ini,snippets/host.yaml' --graph
```
- 或使用「目錄」作為 inventory 來源（建議將多檔放同資料夾）：
```bash
ansible-inventory -i snippets/ --graph
```

## 群組、子群組與變數

YAML Inventory 可清楚表達子群組與群組變數：
```yaml
---
all:
  children:
    web:
      hosts:
        web01: { ansible_host: 192.0.2.21 }
        web02: { ansible_host: 192.0.2.22 }
    db:
      hosts:
        db01: { ansible_host: 192.0.2.31 }
  vars:
    ansible_user: ubuntu
```

群組/主機變數最佳實務：
- `group_vars/<group>.yaml` 放群組變數；`host_vars/<host>.yaml` 放單機變數
- 變數優先序（片段）：`-e` > task vars > play vars > host_vars > group_vars > role defaults


## 主機匹配語法（Patterns）

```bash
# 指定群組或主機
ansible web -i snippets/host.yaml -m ping
ansible web[0] -i snippets/host.yaml -m ping       # 第一台（若支援索引）

# 運算子
ansible 'web:&prod' -i snippets/host.yaml -m ping  # 交集
ansible 'web:db'    -i snippets/host.yaml -m ping  # 聯集
ansible 'all:!db'   -i snippets/host.yaml -m ping  # 差集（排除 db）
```

## 動態 Inventory：Plugins 與 Constructed

1) Constructed：依現有 hostvars 分群或產生衍生變數（不需外部雲端）
```yaml
---
# snippets/inventory-constructed.yaml（示例）
plugin: constructed
strict: false
compose:
  app_env: "{{ hostvars[inventory_hostname].app_env | default('dev') }}"
groups:
  web: "'web' in (hostvars[inventory_hostname].roles | default([]))"
  prod: "hostvars[inventory_hostname].app_env | default('dev') == 'prod'"
keyed_groups:
  - key: app_env
    prefix: env
```
使用方式：
```bash
ansible-inventory -i 'snippets/inventory.ini,snippets/host.yaml,snippets/inventory-constructed.yaml' --graph
```

2) 雲端 Plugins（觀念）
- 常見：`aws_ec2`、`azure_rm`、`gcp_compute`、`k8s` 等
- 以外部 API 查詢主機列表，並可用 `filters` 與 `keyed_groups` 動態分組
- 需安裝相應 collections，並提供憑證與連線設定

## 與 Facts 的互動

- `ansible-inventory` 不會連線主機蒐集 facts；Constructed 依賴 inventory 現有變數
- 在 Play 中可先收集 facts 再用 `group_by` 進一步分群：
```yaml
---
- hosts: all
  gather_facts: true
  tasks:
    - name: Group by OS family
      group_by:
        key: "os_{{ ansible_facts['os_family'] | lower }}"
```

## 最小可跑範例：列印 Inventory 與群組資訊

```yaml
---
# snippets/inventory-inspect.yml（示例）
- name: Inspect inventory
  hosts: all
  gather_facts: false
  tasks:
    - name: Show host summary
      debug:
        msg:
          - "host={{ inventory_hostname }}"
          - "ip={{ ansible_host | default('N/A') }}"
          - "groups={{ group_names | join(',') }}"
```

驗證與檢查：
```bash
ansible-inventory -i 'snippets/inventory.ini,snippets/host.yaml' --graph
ansible-playbook -i 'snippets/inventory.ini,snippets/host.yaml' snippets/inventory-inspect.yml --syntax-check
#（選）
ansible-lint snippets/inventory-inspect.yml
yamllint snippets/
```

## 常見問題與排錯

- 「找不到主機」：確認 inventory 路徑與檔案格式、或逗號分隔是否加引號
- 「變數覆蓋不如預期」：檢查優先序與變數存放位置（host_vars vs group_vars）
- 「Constructed 沒生效」：檔名是否被讀取、條件運算式是否正確、字串需加引號
- 「Plugin 認證錯誤」：雲端插件需對應的 credentials 與組態，可先用 `--list` 測試

## 作業練習

- 練習 1：將 `snippets/inventory.ini` 的主機加上 `roles=['web']`，再用 Constructed 分出 `web` 群組
- 練習 2：新增 `group_vars/web.yaml` 設定 `app_port=8000`，在簡單 Play 中印出該值
- 練習 3：撰寫 `inventory-inspect.yml` 顯示每台主機所屬的 `env*` 群組（搭配 keyed_groups）

## 明日預告
>
